<!DOCTYPE html>

<html>
<head>
	<title>Hello App</title>

	<script type="text/javascript" src="/scripts/jquery-1.9.1.min.js" />

	<script type="text/javascript" src="/scripts/forcetk.js" />

	<script type="text/javascript">
		$ (function () {
			function log (txt) {
				alert (txt);
				$ ('log').append ('<li>').text (txt);
			};

			function gotoUrlClick () {
				var url = 'http://login.salesforce.com/';
				log ('goto ' + url);
				var ref = window.open (url);
				ref.addEventListener ('loadstart', function (e) { log (JSON.stringify (e)); });
				ref.addEventListener ('loadstop', function (e) { log (JSON.stringify (e)); });
				ref.addEventListener ('loaderror', function (e) { log (JSON.stringify (e)); });
				ref.addEventListener ('exit', function (e) { log (JSON.stringify (e)); });
			};

			String.prototype.startsWith = function(str) { return (this.substr(0, str.length) === str); }

			log ('adding deviceready event listener to document');
			document.addEventListener("deviceready", function (e) { log (JSON.stringify (e)); }, false);

			// OAuth Configuration
			var loginUrl = 'https://login.salesforce.com/';
			var clientId = '3MVG9Km_cBLhsuPzTtcGHsZpj9HSp.uUwbHupEXhWi6k3JJphEv8swpsUYIFCZSLp8pi7YYMbRjeQUxptYdIt';
			var redirectUri = 'https://login.salesforce.com/services/oauth2/success';

			var client = new forcetk.Client(clientId, loginUrl);

			function getAuthorizeUrl(loginUrl, clientId, redirectUri) {
			    return loginUrl + 'services/oauth2/authorize?display=touch'
			    + '&response_type=token&client_id=' + escape(clientId)
			    + '&redirect_uri=' + escape(redirectUri);
			};

            var cb = ChildBrowser.install();
            
            $('#login').click(function(e) {
                e.preventDefault();
                cb.onLocationChange = function(loc){   
                    if (loc.startsWith(redirectUri)) {
                        cb.close();
                        sessionCallback(unescape(loc));
                    }
                };
                cb.showWebPage(getAuthorizeUrl(loginUrl, clientId, redirectUri));
            });

	        function sessionCallback(loc) {
	            var oauthResponse = {};

	            var fragment = loc.split("#")[1];

	            if (fragment) {
	                var nvps = fragment.split('&');
	                for (var nvp in nvps) {
	                    var parts = nvps[nvp].split('=');
	                    oauthResponse[parts[0]] = unescape(parts[1]);
	                }
	            }

	            if (typeof oauthResponse === 'undefined' || typeof oauthResponse['access_token'] === 'undefined') {
	                errorCallback({status: 0, statusText: 'Unauthorized', responseText: 'No OAuth response'});
	            } else {
	                client.setSessionToken(oauthResponse.access_token, null, oauthResponse.instance_url);

	                client.query("SELECT Name FROM Account LIMIT 1", 
	                    function(response){
	                        $('#message').html('The first account I see is '
	                        +response.records[0].Name);
	                    }
	                );
	            }
	        }


		});
	</script>
</head>
<body>
	<h1>Hello VF!</h1>

	<p id="message">Click here.</p>

	<button type="button" id="login">go to ...</button>

	<ul id="log"></ul>
</body>
</html>
