<!DOCTYPE html>

<html>
<head>
	<title>Hello App</title>

	<script src="phonegap.js"></script>
	<script src="childbrowser.js" ></script>

	<script type="text/javascript" src="scripts/jquery-1.9.1.min.js"></script>

	<script type="text/javascript" src="scripts/forcetk.js"></script>

	<script type="text/javascript">
		function log (txt) {
			alert (txt);
			$ ('#log').append ($ ('<li>').append ('<pre>').html (txt));
		}

		String.prototype.startsWith = function (str) { return (this.substr(0, str.length) === str); }

		function deviceReady () {
			// OAuth Configuration
			var loginUrl = 'https://login.salesforce.com/';
			var clientId = '3MVG99qusVZJwhslGI._DuPtlMPe9V0ymb6n.SANvHchAqg0mhEPhPz6lDQ71b5RS8bMeYeCSLIlfsJBWwNx7';
			var redirectUri = 'https://login.salesforce.com/services/oauth2/success';

			var client = new forcetk.Client(clientId, loginUrl);

			function getAuthorizeUrl(loginUrl, clientId, redirectUri) {
			    return loginUrl + 'services/oauth2/authorize?display=touch'
			    + '&response_type=token&client_id=' + escape(clientId)
			    + '&redirect_uri=' + escape(redirectUri);
			};


            if (! window.plugins || ! window.plugins.childBrowser)
            	ChildBrowser.install();

            var cb = window.plugins.childBrowser;

            (function login () {
                cb.onLocationChange = function(loc){
                    if (loc.startsWith(redirectUri)) {
                        cb.close();
                        sessionCallback(unescape(loc));
                    }
                };
            
                cb.showWebPage(getAuthorizeUrl(loginUrl, clientId, redirectUri));
            })();

	        function sessionCallback(loc) {
	            var oauthResponse = {};

	            var fragment = loc.split("#")[1];

	            if (fragment) {
	                var nvps = fragment.split('&');
	                for (var i = 0; i < nvps.length; ++ i) {
	                    var parts = nvps[i].split('=');
	                    oauthResponse[parts[0]] = unescape(parts[1]);
	                }
	            }

	            if (typeof oauthResponse['access_token'] === 'undefined') {
	                log ('Unauthorized: No OAuth response.');
	            } else {
	                client.setSessionToken(oauthResponse.access_token, null, oauthResponse.instance_url);

	                client.query("SELECT Name FROM Account LIMIT 1", 
	                    function(response){
	                        $('#message').html('The first account I see is '
	                        +response.records[0].Name);
	                    }
	                );
	            }
	        }

	        (function db_func () {
	        	var db = window.openDatabase('test', '1.0', 'Test DB', 1000000);

			   function populateDB(tx) {
			         tx.executeSql('DROP TABLE IF EXISTS DEMO');
			         tx.executeSql('CREATE TABLE IF NOT EXISTS DEMO (id unique, data)');
			         tx.executeSql('INSERT INTO DEMO (id, data) VALUES (1, "First row")');
			         tx.executeSql('INSERT INTO DEMO (id, data) VALUES (2, "Second row")');
			    }

			    function errorCB(tx, err) {
			        log("Error processing SQL: "+err);
			    }
			    function successCB() {
			        log("success!");
			    }
    
	        	db.transaction(populateDB, errorCB, successCB);
	        })();
		}

		function onLoad () {
			document.addEventListener ("deviceready", deviceReady, false);
		}
	</script>
</head>
<body onload="onLoad()">
	<p id="message">= = =</p>
	<br />
	<ul id="log"></ul>
</body>
</html>
