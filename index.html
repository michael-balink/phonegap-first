<!DOCTYPE html>

<html>
<head>
	<title>Hello App</title>

	<script src="phonegap.js"></script>
	<script src="childbrowser.js" ></script>

	<script type="text/javascript" src="scripts/jquery-1.9.1.min.js"></script>

	<script type="text/javascript" src="scripts/forcetk.js"></script>

	<script type="text/javascript">
		function log (txt) {
			alert (txt);
			$ ('#log').append ($ ('<li>').append ('<pre>').html (txt));
		}

		String.prototype.startsWith = function (str) { return (this.substr(0, str.length) === str); }

		function deviceReady () {
			// OAuth Configuration
			var loginUrl = 'https://login.salesforce.com/';
			var clientId = '3MVG99qusVZJwhslGI._DuPtlMPe9V0ymb6n.SANvHchAqg0mhEPhPz6lDQ71b5RS8bMeYeCSLIlfsJBWwNx7';
			//var redirectUri = 'https://login.salesforce.com/services/oauth2/success';
			var redirectUri = 'myapp:///mobilesdk/detect/oauth/done';

			var client = new forcetk.Client(clientId, loginUrl);

			function getAuthorizeUrl(loginUrl, clientId, redirectUri) {
			    return loginUrl + 'services/oauth2/authorize?display=touch'
			    + '&response_type=token&client_id=' + escape(clientId)
			    + '&redirect_uri=' + escape(redirectUri);
			};


        try {
            if (! window.plugins.childBrowser) {
            	log ('install ChildBrowser');
            	ChildBrowser.install();
            	log ('finish');
            } else
            	log ('childBrowser present');
        } catch (e) {
        	log (JSON.stringify (e));
        }

            var cb = window.plugins.childBrowser; //ChildBrowser.install();

            log ('bbb!');
            log (JSON.stringify (cb));

            $('#login').click(function(e) {
                e.preventDefault();
            
                cb.onLocationChange = function(loc){
                	alert (loc);
//                    if (loc.startsWith(redirectUri)) {
                    if (loc === 'https://eu2.salesforce.com/_ui/identity/oauth/ui/AuthorizationPage') {
	                	alert ('a');
                        cb.close();
                        sessionCallback(unescape(loc));
                    }
                };
            
                cb.showWebPage(getAuthorizeUrl(loginUrl, clientId, redirectUri));
            });

	        function sessionCallback(loc) {
	            var oauthResponse = {};

	            var fragment = loc.split("#")[1];
                	alert (fragment);

	            if (fragment) {
	                var nvps = fragment.split('&');
	                for (var nvp in nvps) {
	                    var parts = nvps[nvp].split('=');
	                    oauthResponse[parts[0]] = unescape(parts[1]);
	                }
	            }

	            if (typeof oauthResponse === 'undefined' || typeof oauthResponse['access_token'] === 'undefined') {
	                errorCallback({status: 0, statusText: 'Unauthorized', responseText: 'No OAuth response'});
	            } else {
	                client.setSessionToken(oauthResponse.access_token, null, oauthResponse.instance_url);

	                client.query("SELECT Name FROM Account LIMIT 1", 
	                    function(response){
	                        $('#message').html('The first account I see is '
	                        +response.records[0].Name);
	                    }
	                );
	            }
	        }
		}

		function onLoad () {
			document.addEventListener ("deviceready", deviceReady, false);
		}
	</script>
</head>
<body onload="onLoad()">
	<h1>Hello VF!</h1>

	<p id="message">Click here.</p>

	<button type="button" id="login">Login to SF ...</button>

	<ul id="log"></ul>
</body>
</html>
